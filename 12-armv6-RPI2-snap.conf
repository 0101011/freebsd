#!/bin/sh
#
# $FreeBSD$
#

BUILDBRANCH="12"

. "${__BUILDCONFDIR}/defaults-${BUILDBRANCH}.conf"

export RELENGDIR="$(realpath $(dirname $(basename ${0})))/../release"

EMBEDDED_TARGET_ARCH="armv6"
EMBEDDED_TARGET="arm"
EMBEDDEDBUILD=1
EMBEDDEDPORTS="sysutils/u-boot-rpi2"
FAT_SIZE="50m"
FAT_TYPE="16"
IMAGE_SIZE="1536M"
KERNEL_FLAGS="-j6"
KERNEL="GENERIC"
MD_ARGS="-x 63 -y 255"
NODOC=1
NOPORTS=
PART_SCHEME="MBR"
WORLD_FLAGS="-j10"
WORLD_FLAGS="${WORLD_FLAGS} UBLDR_LOADADDR=0x2000000"
export BOARDNAME="RPI2"

export __CONFIG_NAME="${BUILDBRANCH}-${EMBEDDED_TARGET_ARCH}-${BOARDNAME}-${BUILDTYPE}"
export CHROOTDIR="${__WRKDIR_PREFIX}/${__CONFIG_NAME}"

load_stage_env() {
	TARGET=${EMBEDDED_TARGET}
	TARGET_ARCH=${EMBEDDED_TARGET_ARCH}
}

if [ ! -z ${FTP_STAGING} ]; then
	load_stage_env
fi

arm_install_uboot() {
	UBOOT_DIR="/usr/local/share/u-boot/u-boot-rpi2"
	UBOOT_FILES="bootcode.bin config.txt fixup.dat fixup_cd.dat \
		fixup_x.dat start.elf start_cd.elf start_x.elf u-boot.bin"
	FATMOUNT="${DESTDIR%${KERNEL}}/fat"
	UFSMOUNT="${DESTDIR%${KERNEL}}/ufs"
	chroot ${CHROOTDIR} mkdir -p "${FATMOUNT}" "${UFSMOUNT}"
	chroot ${CHROOTDIR} mount_msdosfs /dev/${mddev}s1 ${FATMOUNT}
	chroot ${CHROOTDIR} mount /dev/${mddev}s2a ${UFSMOUNT}
	for _UF in ${UBOOT_FILES}; do
		chroot ${CHROOTDIR} cp -p ${UBOOT_DIR}/${_UF} \
			${FATMOUNT}/${_UF}
	done
	chroot ${CHROOTDIR} cp -p ${UFSMOUNT}/boot/ubldr ${FATMOUNT}/ubldr
	chroot ${CHROOTDIR} cp -p ${UFSMOUNT}/boot/ubldr.bin \
		${FATMOUNT}/ubldr.bin
	chroot ${CHROOTDIR} cp -p ${UFSMOUNT}/boot/dtb/rpi2.dtb \
		${FATMOUNT}/rpi2.dtb
	chroot ${CHROOTDIR} touch ${UFSMOUNT}/firstboot
	sync
	umount_loop ${CHROOTDIR}/${FATMOUNT}
	umount_loop ${CHROOTDIR}/${UFSMOUNT}
	chroot ${CHROOTDIR} rmdir ${FATMOUNT}
	chroot ${CHROOTDIR} rmdir ${UFSMOUNT}
	
	return 0
}
